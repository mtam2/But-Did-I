<!--
  But Did I?
  Copyright (C) 2026 Maxim Tam

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program. If not, see <https://www.gnu.org/licenses/>.
-->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>But Did I?</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f5f5f5;
        color: #333;
        padding: 20px;
        max-width: 900px;
        margin: 0 auto;
      }
      h1 {
        margin-bottom: 20px;
      }
      h2 {
        margin: 24px 0 12px;
        font-size: 1.1rem;
        color: #555;
      }

      /* Add timer form */
      .add-form {
        display: flex;
        gap: 8px;
        align-items: flex-end;
        flex-wrap: wrap;
        margin-bottom: 24px;
        background: #fff;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .add-form label {
        display: flex;
        flex-direction: column;
        font-size: 0.8rem;
        color: #777;
        gap: 4px;
      }
      .add-form input,
      .add-form select {
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.95rem;
      }
      .add-form input[type="color"] {
        width: 50px;
        height: 36px;
        padding: 2px;
        cursor: pointer;
      }
      .add-form button {
        width: 40px;
        height: 40px;
        border: none;
        background: #333;
        color: #fff;
        border-radius: 8px;
        font-size: 1.4rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .add-form button:hover {
        background: #555;
      }

      /* Timer cards */
      .category-group {
        margin-bottom: 16px;
      }
      .timers-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .timer-card {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        width: 170px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 4px solid var(--card-color);
        position: relative;
      }
      .timer-name {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 6px;
        word-break: break-word;
      }
      .timer-elapsed {
        font-size: 1.6rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
        margin-bottom: 4px;
      }
      .timer-reset-time {
        font-size: 0.7rem;
        color: #999;
        margin-bottom: 10px;
      }
      .reset-btn {
        border: 2px solid var(--card-color);
        background: none;
        color: var(--card-color);
        font-weight: 600;
        padding: 6px 18px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.85rem;
      }
      .reset-btn:hover {
        background: var(--card-color);
        color: #fff;
      }
      .delete-btn {
        position: absolute;
        top: 4px;
        right: 8px;
        background: none;
        border: none;
        color: #ccc;
        cursor: pointer;
        font-size: 1rem;
      }
      .delete-btn:hover {
        color: #e44;
      }

      /* Reset log */
      #log-section {
        margin-top: 32px;
      }
      #log-section h2 {
        margin-bottom: 8px;
      }
      #log-list {
        list-style: none;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        max-height: 300px;
        overflow-y: auto;
      }
      #log-list li {
        padding: 8px 14px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.85rem;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      #log-list li:last-child {
        border-bottom: none;
      }
      .log-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .log-time {
        color: #999;
        margin-left: auto;
        white-space: nowrap;
      }
      #btn-clear-log {
        background: none;
        border: none;
        color: #ccc;
        cursor: pointer;
        font-size: 1rem;
        vertical-align: middle;
      }
      #btn-clear-log:hover {
        color: #e44;
      }
      .empty-state {
        color: #aaa;
        text-align: center;
        padding: 30px;
      }
    </style>
  </head>
  <body>
    <h1>But Did I?</h1>

    <div class="add-form">
      <label>
        Name
        <input type="text" id="inp-name" placeholder="e.g. Iron" />
      </label>
      <label>
        Category
        <input
          type="text"
          id="inp-category"
          placeholder="e.g. Supplements"
          list="category-list"
        />
        <datalist id="category-list"></datalist>
      </label>
      <label>
        Color
        <input type="color" id="inp-color" value="#e53935" />
      </label>
      <button id="btn-add" title="Add timer">+</button>
    </div>

    <div id="timers-container"></div>

    <div id="log-section">
      <h2>Reset Log <button id="btn-clear-log" title="Clear log">&times;</button></h2>
      <ul id="log-list"></ul>
    </div>

    <script>
      const STORAGE_KEY = "but_did_i";

      let state = loadState();

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) return JSON.parse(raw);
        } catch (e) {
          console.warn("Failed to load state:", e);
        }
        return { timers: [], log: [] };
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function formatElapsed(ms) {
        const totalSec = Math.floor(ms / 1000);
        const h = Math.floor(totalSec / 3600);
        const m = Math.floor((totalSec % 3600) / 60);
        const s = totalSec % 60;
        if (h > 0)
          return `${h}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
        return `${m}:${String(s).padStart(2, "0")}`;
      }

      function formatAbsolute(ts) {
        if (!ts) return "";
        const d = new Date(ts);
        const month = d.getMonth() + 1;
        const day = d.getDate();
        let hours = d.getHours();
        const mins = String(d.getMinutes()).padStart(2, "0");
        const ampm = hours >= 12 ? "pm" : "am";
        hours = hours % 12 || 12;
        return `${month}/${day} ${hours}:${mins}${ampm}`;
      }

      function addTimer(name, category, color) {
        const now = Date.now();
        state.timers.push({ id: now, name, category, color, resetTime: now });
        saveState();
        render();
      }

      function resetTimer(id) {
        const timer = state.timers.find((t) => t.id === id);
        if (!timer) return;
        const now = Date.now();
        const elapsed = formatElapsed(now - timer.resetTime);
        state.log.unshift({
          name: timer.name,
          color: timer.color,
          elapsed,
          time: now,
        });
        timer.resetTime = now;
        if (state.log.length > 200) state.log.length = 200;
        saveState();
        render();
      }

      function deleteTimer(id) {
        state.timers = state.timers.filter((t) => t.id !== id);
        saveState();
        render();
      }

      function render() {
        const container = document.getElementById("timers-container");
        const logList = document.getElementById("log-list");
        const datalist = document.getElementById("category-list");

        // Group timers by category
        const groups = {};
        for (const t of state.timers) {
          const cat = t.category || "Uncategorized";
          if (!groups[cat]) groups[cat] = [];
          groups[cat].push(t);
        }

        // Update category datalist
        datalist.innerHTML = "";
        for (const cat of Object.keys(groups)) {
          const opt = document.createElement("option");
          opt.value = cat;
          datalist.appendChild(opt);
        }

        // Render timer cards
        if (state.timers.length === 0) {
          container.innerHTML =
            '<div class="empty-state">No timers yet. Add one above.</div>';
        } else {
          let html = "";
          for (const [cat, timers] of Object.entries(groups)) {
            html += `<div class="category-group"><h2>${esc(cat)}</h2><div class="timers-grid">`;
            for (const t of timers) {
              const elapsed = Date.now() - t.resetTime;
              html += `
          <div class="timer-card" style="--card-color:${esc(t.color)}" data-id="${t.id}">
            <button class="delete-btn" onclick="deleteTimer(${t.id})" title="Delete">&times;</button>
            <div class="timer-name">${esc(t.name)}</div>
            <div class="timer-elapsed">${formatElapsed(elapsed)}</div>
            <div class="timer-reset-time">${formatAbsolute(t.resetTime)}</div>
            <button class="reset-btn" style="--card-color:${esc(t.color)}" onclick="resetTimer(${t.id})">reset</button>
          </div>`;
            }
            html += "</div></div>";
          }
          container.innerHTML = html;
        }

        // Render log
        if (state.log.length === 0) {
          logList.innerHTML = '<li class="empty-state">No resets yet.</li>';
        } else {
          logList.innerHTML = state.log
            .map(
              (entry) => `
      <li>
        <span class="log-dot" style="background:${esc(entry.color)}"></span>
        <span><strong>${esc(entry.name)}</strong> after ${esc(entry.elapsed)}</span>
        <span class="log-time">${formatAbsolute(entry.time)}</span>
      </li>`,
            )
            .join("");
        }
      }

      function esc(s) {
        const div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      // Add timer handler
      document.getElementById("btn-add").addEventListener("click", () => {
        const name = document.getElementById("inp-name").value.trim();
        const category = document.getElementById("inp-category").value.trim();
        const color = document.getElementById("inp-color").value;
        if (!name) {
          document.getElementById("inp-name").focus();
          return;
        }
        addTimer(name, category || "Uncategorized", color);
        document.getElementById("inp-name").value = "";
      });

      document.getElementById("btn-clear-log").addEventListener("click", () => {
        if (state.log.length === 0) return;
        if (!confirm("Clear the entire reset log? This cannot be undone.")) return;
        state.log = [];
        saveState();
        render();
      });

      document.getElementById("inp-name").addEventListener("keydown", (e) => {
        if (e.key === "Enter") document.getElementById("btn-add").click();
      });

      // Tick every second to update elapsed times
      setInterval(() => {
        document.querySelectorAll(".timer-card").forEach((card) => {
          const id = Number(card.dataset.id);
          const timer = state.timers.find((t) => t.id === id);
          if (!timer) return;
          card.querySelector(".timer-elapsed").textContent = formatElapsed(
            Date.now() - timer.resetTime,
          );
        });
      }, 1000);

      render();
    </script>
  </body>
</html>
